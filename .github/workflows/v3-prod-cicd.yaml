name: Backend CI - Push to ECR

on:
  push:
    branches:
      - main
      - develop
      - infra/ci-test # í…ŒìŠ¤íŠ¸ìš©
  workflow_dispatch:
    inputs:
      version:
        description: 'ë¦´ë¦¬ì¦ˆ ë²„ì „ íƒœê·¸ (ì˜ˆ: v3.0.0)'
        required: false

jobs:
  build-and-push:
    name: Build & Push to AWS ECR
    runs-on: ubuntu-latest
    
    env:
      AWS_REGION: ap-northeast-2
      SERVICE: backend
      ENVIRONMENT: prod
      
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3
       
      - name: Set image tags and URI
        run: |
          # ì‹œê°„ ê¸°ë°˜ íƒœê·¸
          TIME_TAG="${{ env.ENVIRONMENT }}-$(TZ=Asia/Seoul date +'%Y%m%d-%H%M')"
          echo "TIME_TAG=$TIME_TAG" >> $GITHUB_ENV
          
          # ë¸Œëžœì¹˜ë³„ íƒœê·¸
          BRANCH_NAME=${GITHUB_REF##*/}
          BRANCH_TAG="${{ env.ENVIRONMENT }}-${BRANCH_NAME}"
          echo "BRANCH_TAG=$BRANCH_TAG" >> $GITHUB_ENV
          
          # ì»¤ë°‹ í•´ì‹œ íƒœê·¸ (ì§§ì€ ë²„ì „)
          COMMIT_TAG="${{ env.ENVIRONMENT }}-$(echo $GITHUB_SHA | cut -c1-7)"
          echo "COMMIT_TAG=$COMMIT_TAG" >> $GITHUB_ENV
          
          # ECR URI
          IMAGE_URI="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.SERVICE }}"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          
          # ì‚¬ìš©ìž ì •ì˜ ë²„ì „ì´ ìžˆìœ¼ë©´ ì‚¬ìš©
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            CUSTOM_TAG="${{ github.event.inputs.version }}"
            echo "CUSTOM_TAG=$CUSTOM_TAG" >> $GITHUB_ENV
          fi
       
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
       
      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} \
          | docker login --username AWS \
            --password-stdin "${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
       
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
       
      - name: Gradle Build
        env:
          CI: true
        run: ./gradlew clean build --no-daemon
       
      - name: Build and Push Docker Image to ECR
        run: |
          # ì—¬ëŸ¬ íƒœê·¸ë¡œ ë™ì‹œì— ë¹Œë“œ ë° í‘¸ì‹œ
          TAGS=(
            "${IMAGE_URI}:${TIME_TAG}"
            "${IMAGE_URI}:${BRANCH_TAG}"
            "${IMAGE_URI}:${COMMIT_TAG}"
          )
          
          # main ë¸Œëžœì¹˜ì¸ ê²½ìš° latest íƒœê·¸ë„ ì¶”ê°€
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            TAGS+=("${IMAGE_URI}:latest")
          fi
          
          # ì‚¬ìš©ìž ì •ì˜ íƒœê·¸ê°€ ìžˆìœ¼ë©´ ì¶”ê°€
          if [ -n "$CUSTOM_TAG" ]; then
            TAGS+=("${IMAGE_URI}:${CUSTOM_TAG}")
          fi
          
          # íƒœê·¸ ëª©ë¡ì„ docker buildx ëª…ë ¹ì–´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          TAG_ARGS=""
          for tag in "${TAGS[@]}"; do
            TAG_ARGS="${TAG_ARGS} -t ${tag}"
          done
          
          echo "Building with tags: ${TAGS[*]}"
          
          docker buildx build \
            --platform linux/amd64 \
            ${TAG_ARGS} \
            --push .
            
      - name: Output image info
        run: |
          echo "### ðŸ‹ Built Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${{ env.IMAGE_URI }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.TIME_TAG }}\` (ì‹œê°„ ê¸°ë°˜)" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.BRANCH_TAG }}\` (ë¸Œëžœì¹˜ ê¸°ë°˜)" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.COMMIT_TAG }}\` (ì»¤ë°‹ ê¸°ë°˜)" >> $GITHUB_STEP_SUMMARY
          
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            echo "- \`latest\` (ìµœì‹ )" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "- \`${{ github.event.inputs.version }}\` (ì‚¬ìš©ìž ì •ì˜)" >> $GITHUB_STEP_SUMMARY
          fi